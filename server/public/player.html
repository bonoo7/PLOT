<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุญุจูุฉ - ุงูุนููู</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <div class="stamp">ุณุฑู</div>
        <h1>ุชุณุฌูู ุงูุฏุฎูู</h1>
        
        <div id="header-role" class="hidden" style="position: absolute; top: 10px; left: 10px; background: var(--text-color); color: var(--bg-color); padding: 5px 10px; font-size: 0.8rem; border-radius: 5px; z-index: 100;">
            ุงูุฏูุฑ: <span id="header-role-name"></span>
        </div>

        <div id="login-screen">
            <input type="text" id="player-name" placeholder="ุงูุงุณู ุงูุญุฑูู" maxlength="12" autocomplete="off">
            <input type="text" id="room-code" placeholder="ุฑูุฒ ุงูุบุฑูุฉ" maxlength="4" style="text-transform: uppercase;" autocomplete="off">
            <button id="join-btn">ุงูุถูุงู ูููููุฉ</button>
            <div id="error-msg" class="error"></div>
        </div>

        <div id="waiting-screen" class="hidden">
            <h2>ุชู ูุจูู ุงูุชุตุฑูุญ</h2>
            <p>ุฃููุงู ุจุงูุนููู <span id="display-name" style="font-weight: bold;"></span></p>
            <p>ุงูุญุงูุฉ: <span style="color: var(--accent-red);">ูุถุน ุงูุงุณุชุนุฏุงุฏ</span></p>
            <div class="stamp" style="margin-top: 30px; transform: rotate(10deg);">ุจุงูุชุธุงุฑ ุงูููุงุฏุฉ</div>
            
            <div id="leader-controls" class="hidden" style="margin-top: 30px; border-top: 1px dashed #000; padding-top: 20px;">
                <p style="font-weight: bold;">ุฃูุช ุงููุงุฆุฏ</p>
                <button id="start-game-btn" style="background-color: var(--accent-red); color: white; margin-bottom: 10px;">ุจุฏุก ุงููููุฉ</button>
                
                <div style="margin-top: 10px; border: 1px solid #ccc; padding: 10px;">
                    <p style="margin: 0 0 5px 0;">ุฅุนุฏุงุฏุงุช ุงูุชุฏุฑูุจ:</p>
                    <select id="tutorial-role-select" style="width: 100%; padding: 5px; margin-bottom: 5px;">
                        <option value="">ุงุฎุชุฑ ุฏูุฑู (ุนุดูุงุฆู)</option>
                        <option value="WITNESS">ุงูุดุงูุฏ</option>
                        <option value="ARCHITECT">ุงููููุฏุณ</option>
                        <option value="DETECTIVE">ุงููุญูู</option>
                        <option value="SPY">ุงูุฌุงุณูุณ</option>
                        <option value="ACCOMPLICE">ุงููุชูุงุทุฆ</option>
                        <option value="LAWYER">ุงููุญุงูู</option>
                        <option value="TRICKSTER">ุงููุฎุงุฏุน</option>
                        <option value="CITIZEN">ููุงุทู</option>
                    </select>
                    <button id="start-tutorial-btn" style="background-color: var(--text-color); color: white; font-size: 0.9rem; width: 100%;">ุจุฏุก ุชุฏุฑูุจ (Tutorial)</button>
                </div>
            </div>
        </div>

        <div id="role-screen" class="hidden">
            <h2 id="role-name" style="color: var(--accent-red); font-size: 2rem;"></h2>
            <p id="role-desc" style="font-style: italic;"></p>
            <div style="background: rgba(0,0,0,0.05); padding: 15px; margin: 20px 0; border: 1px dashed var(--text-color);">
                <p style="font-weight: bold;">ูุนูููุงุช ุณุฑูุฉ:</p>
                <p id="role-info" style="font-size: 1.2rem;"></p>
            </div>
            <p id="wait-msg" style="margin-top: 20px; color: #666;">ุงุณุชุนุฏ ูููุชุงุจุฉ...</p>
        </div>

        <div id="drafting-screen" class="hidden">
            <div id="drafting-info-box" style="background: rgba(0,0,0,0.05); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; font-size: 0.9rem;">
                <div style="font-weight: bold; color: var(--accent-red);" id="drafting-game-title"></div>
                <div>ุฃูุช: <span id="drafting-role-name" style="font-weight: bold;"></span></div>
                <div id="drafting-role-info" style="font-size: 0.85rem; color: #555;"></div>
            </div>

            <div id="timer" style="font-size: 3rem; font-weight: bold; color: var(--accent-red);">90</div>
            <h2>ุงูุชุจ ุชุจุฑูุฑู</h2>
            <textarea id="answer-input" rows="4" maxlength="140" placeholder="ุงูุชุจ ูุตุชู ููุง..." style="width: 100%; font-size: 1.2rem; padding: 10px; font-family: 'Courier New';"></textarea>
            <div style="text-align: left; margin-bottom: 10px;"><span id="char-count">0</span>/140</div>
            
            <div id="spy-ability-container" class="hidden" style="margin-bottom: 15px;">
                <button id="spy-btn" style="background-color: var(--accent-yellow); color: var(--text-color);">๐๏ธ ุนูู ุงูุตูุฑ</button>
            </div>

            <button id="submit-btn">ุฅุฑุณุงู</button>
        </div>

        <div id="submitted-screen" class="hidden">
            <div class="stamp">ุชู ุงูุฅุฑุณุงู</div>
            <p>ุจุงูุชุธุงุฑ ุจููุฉ ุงูุนููุงุก...</p>
        </div>

        <div id="presentation-screen" class="hidden">
            <h2>ููุช ุงูููุงุฌูุฉ</h2>
            <p>ุงูุธุฑ ููุดุงุดุฉ ุงูุฑุฆูุณูุฉ</p>
        </div>

        <div id="voting-screen" class="hidden">
            <h2>ุงูุชุตููุช</h2>
            
            <h3>1. ุฃูุถู ุฅุฌุงุจุฉ</h3>
            <div id="quality-votes" style="display: flex; flex-direction: column; gap: 10px;"></div>

            <h3>2. ูู ูู ุงูุดุงูุฏุ</h3>
            <div id="identity-votes" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;"></div>

            <button id="vote-btn" style="margin-top: 20px;">ุฅุฑุณุงู ุงูุชุตููุช</button>
        </div>

        <div id="results-screen" class="hidden">
            <h2>ุงููุชุงุฆุฌ</h2>
            <p>ุงูุธุฑ ููุดุงุดุฉ ุงูุฑุฆูุณูุฉ</p>
        </div>

        <div id="end-screen" class="hidden">
            <div class="stamp">ุงูุชูุช ุงููููุฉ</div>
            <h2>ุดูุฑุงู ููุดุงุฑูุชู</h2>
            
            <div id="end-leader-controls" class="hidden" style="margin-top: 20px; border-top: 1px dashed #000; padding-top: 20px;">
                <p style="font-weight: bold;">ุฃูุช ุงููุงุฆุฏ</p>
                <button id="end-start-game-btn" style="background-color: var(--accent-red); color: white; margin-bottom: 10px;">ูุนุจุฉ ุฌุฏูุฏุฉ</button>
                
                <div style="margin-top: 10px; border: 1px solid #ccc; padding: 10px;">
                    <p style="margin: 0 0 5px 0;">ุฅุนุฏุงุฏุงุช ุงูุชุฏุฑูุจ:</p>
                    <select id="end-tutorial-role-select" style="width: 100%; padding: 5px; margin-bottom: 5px;">
                        <option value="">ุงุฎุชุฑ ุฏูุฑู (ุนุดูุงุฆู)</option>
                        <option value="WITNESS">ุงูุดุงูุฏ</option>
                        <option value="ARCHITECT">ุงููููุฏุณ</option>
                        <option value="DETECTIVE">ุงููุญูู</option>
                        <option value="SPY">ุงูุฌุงุณูุณ</option>
                        <option value="ACCOMPLICE">ุงููุชูุงุทุฆ</option>
                        <option value="LAWYER">ุงููุญุงูู</option>
                        <option value="TRICKSTER">ุงููุฎุงุฏุน</option>
                        <option value="CITIZEN">ููุงุทู</option>
                    </select>
                    <button id="end-start-tutorial-btn" style="background-color: var(--text-color); color: white; font-size: 0.9rem; width: 100%;">ุจุฏุก ุชุฏุฑูุจ (Tutorial)</button>
                </div>
            </div>

            <button id="restart-btn" style="margin-top: 20px;">ุฎุฑูุฌ</button>
        </div>
    </div>

    <script>
        const socket = io();
        
        const loginScreen = document.getElementById('login-screen');
        const waitingScreen = document.getElementById('waiting-screen');
        const roleScreen = document.getElementById('role-screen');
        const draftingScreen = document.getElementById('drafting-screen');
        const submittedScreen = document.getElementById('submitted-screen');
        const presentationScreen = document.getElementById('presentation-screen');
        const votingScreen = document.getElementById('voting-screen');
        const resultsScreen = document.getElementById('results-screen');
        const endScreen = document.getElementById('end-screen');
        
        const headerRole = document.getElementById('header-role');
        const headerRoleName = document.getElementById('header-role-name');
        
        const joinBtn = document.getElementById('join-btn');
        const submitBtn = document.getElementById('submit-btn');
        const voteBtn = document.getElementById('vote-btn');
        const spyBtn = document.getElementById('spy-btn');
        const restartBtn = document.getElementById('restart-btn');
        
        // Leader Controls
        const leaderControls = document.getElementById('leader-controls');
        const startGameBtn = document.getElementById('start-game-btn');
        const startTutorialBtn = document.getElementById('start-tutorial-btn');
        
        const endLeaderControls = document.getElementById('end-leader-controls');
        const endStartGameBtn = document.getElementById('end-start-game-btn');
        const endStartTutorialBtn = document.getElementById('end-start-tutorial-btn');
        const endTutorialRoleSelect = document.getElementById('end-tutorial-role-select');

        const nameInput = document.getElementById('player-name');
        const codeInput = document.getElementById('room-code');
        const answerInput = document.getElementById('answer-input');
        const charCount = document.getElementById('char-count');
        const errorMsg = document.getElementById('error-msg');
        const displayName = document.getElementById('display-name');
        const timerDisplay = document.getElementById('timer');
        
        const roleName = document.getElementById('role-name');
        const roleDesc = document.getElementById('role-desc');
        const roleInfo = document.getElementById('role-info');
        
        const qualityVotesContainer = document.getElementById('quality-votes');
        const identityVotesContainer = document.getElementById('identity-votes');
        const spyAbilityContainer = document.getElementById('spy-ability-container');

        const draftingGameTitle = document.getElementById('drafting-game-title');
        const draftingRoleName = document.getElementById('drafting-role-name');
        const draftingRoleInfo = document.getElementById('drafting-role-info');

        let currentRoomCode = '';
        let selectedQuality = null;
        let selectedIdentity = null;
        let myRole = null;
        let myRound = 0;
        let abilityUsed = false;
        let isLeader = false;
        let currentGameTitle = '';

        joinBtn.addEventListener('click', () => {
            const name = nameInput.value.trim();
            const code = codeInput.value.trim().toUpperCase();

            if (!name || !code) {
                errorMsg.textContent = "ุจูุงูุงุช ูุงูุตุฉ";
                return;
            }
            currentRoomCode = code;
            socket.emit('joinRoom', { roomCode: code, playerName: name });
        });

        submitBtn.addEventListener('click', () => {
            const answer = answerInput.value.trim();
            if (!answer) return;
            
            socket.emit('submitAnswer', { roomCode: currentRoomCode, answer });
            draftingScreen.classList.add('hidden');
            submittedScreen.classList.remove('hidden');
        });

        voteBtn.addEventListener('click', () => {
            if (!selectedQuality || !selectedIdentity) {
                alert('ูุฌุจ ุงุฎุชูุงุฑ ุฃูุถู ุฅุฌุงุจุฉ ูุชุฎููู ุงูุดุงูุฏ');
                return;
            }
            socket.emit('submitVote', { 
                roomCode: currentRoomCode, 
                qualityVote: selectedQuality, 
                identityVote: selectedIdentity 
            });
            votingScreen.classList.add('hidden');
            submittedScreen.classList.remove('hidden'); // Reuse submitted screen
        });

        spyBtn.addEventListener('click', () => {
            if (myRole === 'SPY' && !abilityUsed) {
                socket.emit('useAbility', { roomCode: currentRoomCode, abilityType: 'EAGLE_EYE' });
            }
        });

        restartBtn.addEventListener('click', () => {
            location.reload();
        });

        startGameBtn.addEventListener('click', () => {
            socket.emit('startGame');
        });

        startTutorialBtn.addEventListener('click', () => {
            const role = tutorialRoleSelect.value;
            socket.emit('startTutorial', role || null);
        });

        endStartGameBtn.addEventListener('click', () => {
            socket.emit('startGame');
        });

        endStartTutorialBtn.addEventListener('click', () => {
            const role = endTutorialRoleSelect.value;
            socket.emit('startTutorial', role || null);
        });

        answerInput.addEventListener('input', () => {
            const text = answerInput.value;
            charCount.textContent = text.length;
            // Sync draft
            socket.emit('updateDraft', { roomCode: currentRoomCode, draft: text });
        });

        socket.on('joinedRoom', (data) => {
            loginScreen.classList.add('hidden');
            waitingScreen.classList.remove('hidden');
            displayName.textContent = nameInput.value;
            errorMsg.textContent = "";
            
            if (data.isLeader) {
                isLeader = true;
                leaderControls.classList.remove('hidden');
            }
        });

        socket.on('gameStarted', (data) => {
            // Reset state
            currentGameTitle = data.title;
            answerInput.value = '';
            selectedQuality = null;
            selectedIdentity = null;
            abilityUsed = false;
            resultsScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
        });

        socket.on('roleAssigned', (data) => {
            waitingScreen.classList.add('hidden');
            roleScreen.classList.remove('hidden');
            
            myRole = data.role;
            myRound = data.round;
            
            roleName.textContent = data.roleName;
            roleDesc.textContent = data.description;
            roleInfo.textContent = data.info;

            // Show persistent role header
            headerRole.classList.remove('hidden');
            headerRoleName.textContent = data.roleName;
        });

        socket.on('startDrafting', ({ duration }) => {
            roleScreen.classList.add('hidden');
            draftingScreen.classList.remove('hidden');
            timerDisplay.textContent = duration;
            
            // Update Info Box
            draftingGameTitle.textContent = currentGameTitle;
            draftingRoleName.textContent = roleName.textContent;
            draftingRoleInfo.textContent = roleInfo.textContent;

            // Show Spy Ability if applicable
            if (myRole === 'SPY' && myRound >= 1) { // Round 1 for testing
                spyAbilityContainer.classList.remove('hidden');
            } else {
                spyAbilityContainer.classList.add('hidden');
            }
        });

        socket.on('timerUpdate', (time) => {
            timerDisplay.textContent = time;
        });

        socket.on('startPresentation', () => {
            draftingScreen.classList.add('hidden');
            submittedScreen.classList.add('hidden');
            presentationScreen.classList.remove('hidden');
        });

        socket.on('startVoting', (data) => {
            presentationScreen.classList.add('hidden');
            votingScreen.classList.remove('hidden');
            
            // Render Quality Votes
            qualityVotesContainer.innerHTML = '';
            
            // Show Detective Hint
            if (myRole === 'DETECTIVE' && myRound >= 1 && !abilityUsed) {
                const hint = document.createElement('p');
                hint.textContent = "๐ต๏ธ ุงุถุบุท ูุฑุชูู (Double Click) ุนูู ุฅุฌุงุจุฉ ูุงุณุชุฌูุงุจ ุตุงุญุจูุง";
                hint.style.color = "var(--accent-red)";
                hint.style.fontWeight = "bold";
                qualityVotesContainer.appendChild(hint);
            }

            data.answers.forEach(item => {
                const btn = document.createElement('button');
                const isMe = item.id === socket.id;
                
                btn.textContent = item.answer + (isMe ? ' (ุฃูุช)' : '');
                btn.className = 'vote-btn';
                btn.style.width = '100%';
                btn.style.marginBottom = '10px';
                btn.style.backgroundColor = isMe ? '#f0f0f0' : '#fff';
                btn.style.color = isMe ? '#999' : '#000';
                btn.style.border = '1px solid #000';
                btn.disabled = isMe;
                
                btn.onclick = () => {
                    if (isMe) return;
                    Array.from(qualityVotesContainer.querySelectorAll('button')).forEach(c => c.style.backgroundColor = c.disabled ? '#f0f0f0' : '#fff');
                    btn.style.backgroundColor = '#E1AD01'; // Selected
                    selectedQuality = item.id;
                };

                // Detective Ability: Double Click to Interrogate
                btn.ondblclick = () => {
                    if (myRole === 'DETECTIVE' && myRound >= 1 && !abilityUsed && !isMe) {
                        if (confirm('ูู ุชุฑูุฏ ุงุณุชุฌูุงุจ ูุฐุง ุงููุดุชุจู ุจูุ')) {
                            socket.emit('useAbility', { roomCode: currentRoomCode, abilityType: 'INTERROGATION', targetId: item.id });
                        }
                    }
                };

                qualityVotesContainer.appendChild(btn);
            });

            // Render Identity Votes
            identityVotesContainer.innerHTML = '';
            data.players.forEach(player => {
                const btn = document.createElement('button');
                btn.textContent = player.name;
                btn.style.padding = '10px';
                btn.style.backgroundColor = '#fff';
                btn.style.color = '#000';
                btn.style.border = '1px solid #000';
                
                btn.onclick = () => {
                    Array.from(identityVotesContainer.children).forEach(c => c.style.backgroundColor = '#fff');
                    btn.style.backgroundColor = '#E1AD01';
                    selectedIdentity = player.id;
                };
                identityVotesContainer.appendChild(btn);
            });
        });

        socket.on('roundResults', () => {
            votingScreen.classList.add('hidden');
            submittedScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
        });

        socket.on('gameEnded', () => {
            resultsScreen.classList.add('hidden');
            endScreen.classList.remove('hidden');
            
            if (isLeader) {
                endLeaderControls.classList.remove('hidden');
            }
        });

        socket.on('abilityResult', (data) => {
            abilityUsed = true;
            if (data.type === 'EAGLE_EYE') {
                alert(`ุนูู ุงูุตูุฑ:\n\n"${data.content}"`);
                spyAbilityContainer.classList.add('hidden');
            } else if (data.type === 'INTERROGATION') {
                alert(`ูุชูุฌุฉ ุงูุงุณุชุฌูุงุจ:\n\n${data.content}`);
            }
        });

        socket.on('error', (msg) => {
            if (msg.includes('ููุณู')) {
                alert(msg);
            } else {
                errorMsg.textContent = msg;
            }
        });
    </script>
</body>
</html>
