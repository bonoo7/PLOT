<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุญุจูุฉ - ุงูุดุงุดุฉ ุงูุฑุฆูุณูุฉ</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <div class="tape"></div>
        <div class="coffee-stain" style="bottom: 20px; right: 20px;"></div>
        <div class="stamp">ุณุฑู ููุบุงูุฉ</div>
        <h1>ุงูุญุจูุฉ</h1>
        
        <div id="start-screen">
            <p>ุจุฏุก ุงูุนูููุฉ</p>
            <button id="create-btn">ุฅูุดุงุก ุบุฑูุฉ</button>
            <div style="margin-top: 20px;">
                <button id="settings-btn" style="font-size: 0.8rem; padding: 10px;">โ๏ธ ุงูุฅุนุฏุงุฏุงุช</button>
            </div>
        </div>

        <div id="settings-modal" class="hidden" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 2px solid black; z-index: 100; box-shadow: 10px 10px 0 rgba(0,0,0,0.2);">
            <h2>ุงูุฅุนุฏุงุฏุงุช</h2>
            <label>
                <input type="checkbox" id="test-mode-check" checked> ูุถุน ุงูุงุฎุชุจุงุฑ (ูุฏุฑุงุช ูู ุงูุฌููุฉ 1)
            </label>
            <br><br>
            <label>
                ููุช ุงููุชุงุจุฉ: <input type="number" id="timer-input" value="90" style="width: 60px;"> ุซุงููุฉ
            </label>
            <br><br>
            <button id="save-settings-btn">ุญูุธ ูุฅุบูุงู</button>
        </div>

        <div id="lobby-screen" class="hidden">
            <p>ุฑูุฒ ุงูุฏุฎูู</p>
            <div id="room-code-display" class="room-code">----</div>
            
            <p>ุงูุนููุงุก ุงููุชุตููู:</p>
            <ul id="player-list" class="player-list">
                <!-- Players will appear here -->
            </ul>
            
            <div style="margin-top: 40px;">
                <button id="start-game-btn" disabled>ุจุงูุชุธุงุฑ ุงูุนููุงุก...</button>
            </div>
        </div>

        <div id="game-screen" class="hidden">
            <p>ููู ุงููุถูุฉ ุฑูู #849</p>
            <h1 id="scenario-title" style="font-size: 3rem; color: var(--accent-red);"></h1>
            <div class="stamp" style="transform: rotate(5deg); margin-top: 50px;">ุฌุงุฑู ุฌูุน ุงูุฃุฏูุฉ...</div>
        </div>

        <div id="drafting-screen" class="hidden">
            <div id="timer" class="timer-pulse" style="font-size: 5rem; font-weight: bold; color: var(--accent-red);">90</div>
            <h2 class="typewriter-text" style="display: inline-block;">ุฌุงุฑู ูุชุงุจุฉ ุงูุชูุงุฑูุฑ...</h2>
            <ul id="submitted-list" class="player-list"></ul>
        </div>

        <div id="presentation-screen" class="hidden">
            <h1>ุงูุชูุงุฑูุฑ ุงููุงุฑุฏุฉ</h1>
            <div id="answers-container" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;"></div>
        </div>

        <div id="voting-screen" class="hidden">
            <h1>ูุฑุญูุฉ ุงูุชุตููุช</h1>
            <div class="stamp" style="transform: rotate(-5deg);">ุงุฎุชุฑ ุจุญููุฉ</div>
            <p style="font-size: 1.5rem; margin-top: 30px;">ุงูุนููุงุก ูููููู ุจุงูุชุตููุช ุงูุขู...</p>
        </div>

        <div id="results-screen" class="hidden">
            <h1>ูุชุงุฆุฌ ุงูุฌููุฉ</h1>
            <ul id="results-list" class="player-list" style="flex-direction: column;"></ul>
            <div style="margin-top: 30px;">
                <button id="next-round-btn">ุงูุฌููุฉ ุงูุชุงููุฉ</button>
            </div>
        </div>

        <div id="end-screen" class="hidden">
            <div class="stamp">ุงูุชูุช ุงููููุฉ</div>
            <h1>ุงููุชุงุฆุฌ ุงูููุงุฆูุฉ</h1>
            <ul id="final-results-list" class="player-list" style="flex-direction: column;"></ul>
            
            <div style="margin-top: 40px; border-top: 2px dashed var(--text-color); padding-top: 20px;">
                <h2>๐ ููุญุฉ ุงูุดุฑู (ุฃูุถู ุงูุนููุงุก)</h2>
                <ul id="leaderboard-list" class="player-list" style="justify-content: center; gap: 10px;"></ul>
            </div>

            <div style="margin-top: 30px;">
                <button id="restart-btn">ูุนุจุฉ ุฌุฏูุฏุฉ</button>
                <div style="margin-top: 10px;">
                    <select id="end-tutorial-role-select" style="padding: 10px; font-size: 1rem; margin-bottom: 10px;">
                        <option value="">ุงุฎุชุฑ ุฏูุฑู (ุนุดูุงุฆู)</option>
                        <option value="WITNESS">ุงูุดุงูุฏ</option>
                        <option value="ARCHITECT">ุงููููุฏุณ</option>
                        <option value="DETECTIVE">ุงููุญูู</option>
                        <option value="SPY">ุงูุฌุงุณูุณ</option>
                        <option value="ACCOMPLICE">ุงููุชูุงุทุฆ</option>
                        <option value="LAWYER">ุงููุญุงูู</option>
                        <option value="TRICKSTER">ุงููุฎุงุฏุน</option>
                        <option value="CITIZEN">ููุงุทู</option>
                    </select>
                    <br>
                    <button id="end-start-tutorial-btn" style="background-color: #666; font-size: 1rem;">ุจุฏุก ุชุฏุฑูุจ (Tutorial)</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        
        const startScreen = document.getElementById('start-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');
        const draftingScreen = document.getElementById('drafting-screen');
        const presentationScreen = document.getElementById('presentation-screen');
        const votingScreen = document.getElementById('voting-screen');
        const resultsScreen = document.getElementById('results-screen');
        const endScreen = document.getElementById('end-screen');
        
        const roomCodeDisplay = document.getElementById('room-code-display');
        const playerList = document.getElementById('player-list');
        const submittedList = document.getElementById('submitted-list');
        const answersContainer = document.getElementById('answers-container');
        const resultsList = document.getElementById('results-list');
        const finalResultsList = document.getElementById('final-results-list');
        const leaderboardList = document.getElementById('leaderboard-list');
        const timerDisplay = document.getElementById('timer');
        
        const createBtn = document.getElementById('create-btn');
        const startGameBtn = document.getElementById('start-game-btn');
        const nextRoundBtn = document.getElementById('next-round-btn');
        const restartBtn = document.getElementById('restart-btn');
        const scenarioTitle = document.getElementById('scenario-title');

        // Settings Elements
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const testModeCheck = document.getElementById('test-mode-check');
        const timerInput = document.getElementById('timer-input');

        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.remove('hidden');
        });

        saveSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
            // We could emit settings here if we had a backend handler, 
            // but for now we just rely on the hardcoded changes for the "Temporary" request.
            // In a full implementation, we would send:
            // socket.emit('updateSettings', { testMode: testModeCheck.checked, duration: timerInput.value });
        });

        createBtn.addEventListener('click', () => {
            socket.emit('createRoom');
        });

        startGameBtn.addEventListener('click', () => {
            console.log('Start Game button clicked');
            socket.emit('startGame');
        });

        nextRoundBtn.addEventListener('click', () => {
            socket.emit('nextRound');
        });

        restartBtn.addEventListener('click', () => {
            socket.emit('startGame'); // Restart game directly
        });

        socket.on('roomCreated', (code) => {
            startScreen.classList.add('hidden');
            lobbyScreen.classList.remove('hidden');
            roomCodeDisplay.textContent = code;
        });

        socket.on('gameStarted', (data) => {
            lobbyScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden'); // Hide results if coming from previous round
            gameScreen.classList.remove('hidden');
            scenarioTitle.textContent = `ุงูุฌููุฉ ${data.round}/${data.totalRounds}: ${data.title}`;
        });

        socket.on('startDrafting', ({ duration }) => {
            gameScreen.classList.add('hidden');
            draftingScreen.classList.remove('hidden');
            timerDisplay.textContent = duration;
            submittedList.innerHTML = ''; // Clear previous
        });

        socket.on('timerUpdate', (time) => {
            timerDisplay.textContent = time;
        });

        socket.on('playerSubmitted', ({ playerName }) => {
            const li = document.createElement('li');
            li.className = 'player-card';
            li.style.backgroundColor = '#e0ffe0'; // Greenish
            li.textContent = `${playerName} โ`;
            submittedList.appendChild(li);
        });

        socket.on('startPresentation', () => {
            draftingScreen.classList.add('hidden');
            presentationScreen.classList.remove('hidden');
        });

        socket.on('receiveAnswers', (answers) => {
            answersContainer.innerHTML = '';
            answers.forEach(item => {
                const div = document.createElement('div');
                div.className = 'container'; // Reuse container style
                div.style.width = '300px';
                div.style.minHeight = '200px';
                div.innerHTML = `
                    <div class="stamp" style="font-size: 1rem;">ุชูุฑูุฑ</div>
                    <p style="font-size: 1.2rem;">"${item.answer}"</p>
                    <p style="margin-top: 20px; font-weight: bold; color: #666;">- ${item.playerName}</p>
                `;
                answersContainer.appendChild(div);
            });
        });

        socket.on('startVoting', () => {
            presentationScreen.classList.add('hidden');
            votingScreen.classList.remove('hidden');
        });

        socket.on('roundResults', ({ results }) => {
            votingScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            
            resultsList.innerHTML = '';
            results.forEach((p, index) => {
                const li = document.createElement('li');
                li.className = 'player-card';
                li.style.width = '90%';
                li.style.display = 'block';
                li.style.fontSize = '1.2rem';
                li.style.marginBottom = '20px';
                li.style.padding = '15px';
                li.style.border = '2px solid #333';
                li.style.borderRadius = '8px';
                li.style.backgroundColor = '#f5f5f0';
                
                const breakdownHTML = p.breakdown && p.breakdown.length > 0 
                    ? p.breakdown.map(item => `<div style="padding: 5px 0; margin-top: 8px; font-size: 1rem; color: #555;">${item}</div>`).join('')
                    : '<div style="color: #999;">ูุง ุชูุฌุฏ ููุงุท ุฅุถุงููุฉ</div>';
                
                li.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-weight: bold;">#${index + 1} ${p.name} <small style="color: #666;">(${p.role})</small></span>
                        <span style="font-weight: bold; color: #2ecc71;">+${p.roundScore} (ุงููุฌููุน: ${p.totalScore})</span>
                    </div>
                    <div style="border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 8px;">๐ ุชูุตูู ุงูููุงุท:</div>
                        ${breakdownHTML}
                    </div>
                `;
                resultsList.appendChild(li);
            });
        });

        socket.on('gameEnded', ({ results, leaderboard }) => {
            resultsScreen.classList.add('hidden');
            endScreen.classList.remove('hidden');
            
            finalResultsList.innerHTML = '';
            results.forEach((p, index) => {
                const li = document.createElement('li');
                li.className = 'player-card';
                li.style.width = '80%';
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.fontSize = '1.5rem';
                
                // Add trophy for winner
                const trophy = index === 0 ? '๐' : '';
                
                li.innerHTML = `
                    <span>${trophy} #${index + 1} ${p.name}</span>
                    <span>${p.totalScore} ููุทุฉ</span>
                `;
                finalResultsList.appendChild(li);
            });

            // Display Leaderboard
            if (leaderboard) {
                leaderboardList.innerHTML = '';
                leaderboard.forEach((p, index) => {
                    const li = document.createElement('li');
                    li.className = 'player-card';
                    li.style.fontSize = '1rem';
                    li.style.minWidth = '150px';
                    li.style.backgroundColor = '#fffcf0';
                    
                    li.innerHTML = `
                        <div style="font-weight:bold;">#${index + 1} ${p.name}</div>
                        <div style="font-size:0.8rem; color:#666;">ูุฌููุน: ${p.totalScore}</div>
                        <div style="font-size:0.8rem; color:var(--accent-red);">ููุฒ: ${p.wins}</div>
                    `;
                    leaderboardList.appendChild(li);
                });
            }
        });

        socket.on('playerJoined', (players) => {
            playerList.innerHTML = '';
            let connectedCount = 0;
            players.forEach(player => {
                const li = document.createElement('li');
                li.className = 'player-card';
                li.textContent = player.name;
                
                if (player.connected === false) {
                    li.style.opacity = '0.5';
                    li.textContent += ' (ูููุทุน)';
                } else {
                    connectedCount++;
                }
                
                playerList.appendChild(li);
            });

            if (connectedCount >= 3) {
                startGameBtn.disabled = false;
                startGameBtn.textContent = "ุจุฏุก ุงููููุฉ";
            } else {
                startGameBtn.disabled = true;
                startGameBtn.textContent = `ุจุงูุชุธุงุฑ ุงูุนููุงุก... (${connectedCount}/3)`;
            }
        });
    </script>
</body>
</html>